<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.njm.yaho.mapper.oracle.user.UserMapperOC">
	<resultMap id="userResultMap" type="com.njm.yaho.domain.oracle.user.UserOCDTO">
		<result property="userId" column="USER_ID" />
		<result property="userPassword" column="USER_PASSWORD" />
		<result property="userNickname" column="USER_NICKNAME" />
		<result property="userEmail" column="USER_EMAIL" />
		<result property="userBio" column="USER_BIO" />
		<result property="userProfileImg" column="USER_PROFILE_IMG" />
		<result property="userCreatedDate" column="USER_CREATED_DATE" />
		<result property="userPermission" column="USER_PERMISSION" />
		<result property="userGender" column="USER_GENDER" />
	</resultMap>

	<!-- 이메일로 계정 존재여부 확인 -->
	<select id="countByEmail" resultType="int">
		SELECT COUNT(*) FROM TBL_USER
		WHERE USER_EMAIL = #{email}
	</select>

	<!-- ID찾기 값 입력 -->
	<select id="findByEmail" resultMap="userResultMap">
		SELECT * FROM TBL_USER
		WHERE USER_EMAIL = #{email}
	</select>
	
	<!-- 비밀번호 찾기 값 입력 -->
	<select id="findByIdAndEmail" resultMap="userResultMap">
	  SELECT * FROM TBL_USER
	  WHERE USER_ID = #{userId}
	    AND USER_EMAIL = #{email}
	</select>
	
	<!-- 임시 비밀번호 발급 -->
	<update id="updatePassword">
	  UPDATE TBL_USER
	  SET USER_PASSWORD = #{password}
	  WHERE USER_ID = #{userId}
	</update>
	
	<select id="countTodayPwReset" resultType="int">
	  SELECT COUNT(*) FROM TBL_PW_RESET_LOG
	  WHERE USER_ID = #{userId}
	    AND TRUNC(RESET_TIME) = TRUNC(SYSDATE)
	</select>
	
	<select id="findLastPwResetTime" resultType="java.sql.Timestamp">
	  SELECT MAX(RESET_TIME) FROM TBL_PW_RESET_LOG
	  WHERE USER_ID = #{userId}
	</select>
	
	<insert id="insertPwResetLog">
	  INSERT INTO TBL_PW_RESET_LOG (USER_ID, EMAIL, RESET_TIME)
	  VALUES (#{userId}, #{email}, CURRENT_TIMESTAMP)
	</insert>
	
	<!-- 유저 권한 확인 -->
	<select id="checkUserRole" resultType="int">
		SELECT USER_PERMISSION FROM TBL_USER
		WHERE USER_ID = #{userId}
	</select>
	
	<!-- 사용자 프로필 이미지 가져오기 -->
	<select id="getUserProfileImg" resultType="String">
		SELECT USER_PROFILE_IMG FROM TBL_USER
		WHERE USER_ID = #{userId}
	</select>
</mapper>