<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì• ë‹ˆë©”ì´ì…˜ ë°©ì˜ ì‹œê°„í‘œ | YAHO</title>

<link rel="stylesheet" href="/CSS/testSchedule.css">
<link rel="stylesheet" href="/CSS/test.css">
<link rel="stylesheet" href="/CSS/info.css">
<link rel="stylesheet" th:href="@{/CSS/test3.css}">

<link rel="stylesheet" href="/CSS/AnimeMain.css">
<link rel="stylesheet" href="/CSS/info.css">

<!-- favicon -->
<link rel="icon" href="/IMG/favicon/favicon.ico" type="image/x-icon">

<!-- ê¸€ê¼´ -->
<link
	href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap"
	rel="stylesheet">
</head>


<body>
	<div th:replace="~{fragments/nav :: navbar}"></div>
	
    <br><br>
    
	<h1 class = "title-bar">ì• ë‹ˆë©”ì´ì…˜ ë°©ì˜ ì‹œê°„í‘œ</h1>
	
	<!-- ìƒë‹¨ ê³ ì • ìš”ì¼ ë°” -->
	<div class="day-title-bar">
		<div th:each="day : ${daysOfWeek}" class="day-title-cell"
			th:text="${day}">ì›”ìš”ì¼</div>
	</div>

	<div class="schedule-container">
		<!-- ìš”ì¼ë³„ ë°˜ë³µ -->
		<div th:each="day : ${daysOfWeek}" class="day-column">
			<div th:each="anime : ${animeByDay[day.trim()]}" class="anime-card"
				th:data-title="${anime.TITLE}" th:data-rating="${anime.SCORE}"
				th:data-image1="${anime.THUMNAIL_GARO_URL}"
				th:data-image2="${anime.THUMNAIL_SERO_URL}"
				th:data-anime-id="${anime.ANIME_ID}">

				<img th:src="${anime.THUMNAIL_SERO_URL}" alt="ì• ë‹ˆë©”ì´ì…˜ ì´ë¯¸ì§€">
				<div class="anime-title" th:text="${anime.TITLE}">ì œëª©</div>
				<div class="anime-rating" th:text="'â­ ' + ${anime.SCORE}">â­í‰ì </div>
			</div>
		</div>
	</div>

	<!-- ëª¨ë‹¬ -->
	<div id="animeModal" class="modal">
		<div class="modal_content">
			<span class="close" onclick="modal_close()">&times;</span>
			<div class="modal_div">

				<div class="modal_img">
					<img id="modal_img" src="" alt="ì´ë¯¸ì§€">
				</div>

				<!-- ì• ë‹ˆ ìƒì„¸ ì •ë³´ -->
				<div class="anime-info-container">
					<div class="ani-content">
						<section class="ani-section">
							<div class="ani-row">
								<h2>ì• ë‹ˆì œëª©</h2>
								<p id="anime_title"></p>
							</div>
							
							<div class="ani-row">
								<h2>ë°©ì˜ì¼</h2>
								<p id="start_date"></p>
							</div>
							
							<div class="ani-row">
								<h2>ë°©ì˜ì°¨ìˆ˜</h2>
								<p id="total_episode"></p>
							</div>
							
							<div class="ani-row">
								<h2>ì œì‘ì‚¬</h2>
								<p id="studio"><a href="#" id="studio_link">ì œì‘ì‚¬1</a></p>
							</div>
							
							<div class="ani-row">
								<h2>ìƒì˜ë“±ê¸‰</h2>
								<p id="age_rating"></p>
							</div>
							
							<div class="ani-summary">
								<h2>ì• ë‹ˆ ì¤„ê±°ë¦¬</h2>
								<p id="anime_desc">ì¤„ê±°ë¦¬ ë‚´ìš©</p>
								<span id="summaryButton" class="toggle-btn">ë”ë³´ê¸°</span>
							</div>
						</section>
					</div>
				</div>

				<!-- í‰ì  ê²Œì‹œíŒ -->
				<div class="wrap">
				  <div class="rating-container-row">
				    <div class="rating-box">
				      <h1>í‰ì  ê²Œì‹œíŒ</h1>
				
				      <!-- ìˆ˜ì • ì˜ì—­: ìœ ì €ê°€ ì´ë¯¸ í‰ê°€í•œ ê²½ìš°ì—ë§Œ í‘œì‹œ -->
				      <div id="rateFormArea" style="display: none;">
								<div id="rate-image-filter">
									<img src="/IMG/kibon_image.jpg" class="profile-img" />
									<!-- ê¸°ë³¸ í”„ë¡œí•„ -->
								</div>
								<div class="user-id" th:text="${USER_NICKNAME}"></div><input type="hidden" id="rated_user_id" name="USER_ID" th:value="${USER_ID}" />
				        <input type="hidden" id="rated_anime_id" name="ANIME_ID"/>
						<br>
						
				        <!-- ë³„ì  ì…ë ¥ -->
				        <div class="rating" id="rated_stars_area"></div>
				
				        <!-- ëŒ“ê¸€ ì…ë ¥ -->

								<div style="margin-top: 20px;">
									<textarea id="rated_content" rows="4" cols="50" maxlength="100"></textarea>

									<!-- ë²„íŠ¼ì„ ê°€ë¡œë¡œ ì •ë ¬ -->
									<div class="button-container">
										&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
										&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
										&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
										&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
										<button type="button" onclick="updateRate()">ìˆ˜ì •</button>
										<button type="button" onclick="deleteRate()">ì‚­ì œ</button>
										<div id="rated_charCount" class="char-count">0/100</div>
										<!-- ê¸€ììˆ˜ ì¹´ìš´íŠ¸ëŠ” ì˜¤ë¥¸ìª½ ëì— ìœ„ì¹˜ -->
									</div>
								</div>




							</div>
				
				      <!-- ë“±ë¡ ì˜ì—­: í‰ê°€ë¥¼ ì•ˆ í–ˆì„ ë•Œë§Œ í‘œì‹œ -->
							<div id="registerFormArea" style="display: none;">
								<input type="hidden" id="register_anime_id" name="ANIME_ID" />
								<div id="rate-image-filter">
									<img src="/IMG/kibon_image.jpg" class="profile-img" />
									<!-- ê¸°ë³¸ í”„ë¡œí•„ -->
								</div>

								<div class="user-id" th:text="${USER_NICKNAME}"></div>
								<input type="hidden" id="register_user_id" name="USER_ID"th:value="${USER_ID}" /> <br>
								<div class="rating" id="register_stars_area"></div>

								<div style="margin-top: 20px;">
									<textarea id="register_content" rows="4" cols="50"
										maxlength="100"></textarea>

								</div>
								<div class="button-container">
									&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									&nbsp;&nbsp;&nbsp;
									<button type="button" onclick="submitRate()">ë“±ë¡</button>
									<div id="register_charCount" class="char-count">0/100</div>
								</div>
							</div>

						</div>
				
				    <!-- í†µê³„ -->
				    <div class="rating-box2">
				     <h1>í†µê³„</h1>
				     <br>
				     <br>
				     <br>
				     
				      <div class="stats-row">
				        <div class="grade-section">
				          <span id="grade-number" style="font-size: 50px;"></span><br>
				          <span class="grade-badge" id="grade-mark"></span>
				        </div>
				
				        <div class="chart-section">
				          <canvas id="myChart"></canvas>
				        </div>
				
				        <div class="chart-section donut-section">
				          <canvas id="genderChart"></canvas>
				        </div>
				      </div>
				    </div>
				  </div>
				</div>
				
				<!-- ëŒ“ê¸€ ëª©ë¡ ì˜ì—­ -->
				<div class="wrap2" id="comment-list-area">
				  <h1>ê²Œì‹œíŒ ëª©ë¡</h1>
				  <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ì‚½ì… -->
				</div>

				

			</div>
		</div>
	</div>
	<script src="/JS/chart.umd.js"></script>
	<script src="/JS/Rating3.js"></script>
	<!-- ë„ë„› -->
	<script src="/JS/genderChart.js"></script>
	<!-- ë³„ì  ê¸°ëŠ¥ -->
	<script src="/JS/Rating.js"></script>
	<!-- í†µê³„ -->

	<script th:inline="javascript">
    /*<![CDATA[*/
        let voteLabels = /*[[${scoreList}]]*/ [];
        let voteCounts = /*[[${countList}]]*/ [];
    /*]]>*/
    </script>

	<script>
    const ctx2 = document.getElementById('myChart').getContext('2d');

    // âœ… ì „ì—­ì— ë“±ë¡
    window.myChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: voteLabels,
            datasets: [{
                label: 'í‰ì  ë¶„í¬',
                data: voteCounts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',   // 0~1
                    'rgba(54, 162, 235, 0.6)',   // 1~2
                    'rgba(255, 206, 86, 0.6)',   // 2~3
                    'rgba(75, 192, 192, 0.6)',   // 3~4
                    'rgba(153, 102, 255, 0.6)'   // 4~5
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1,
                barPercentage: 0.5,
                categoryPercentage: 0.5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
	<!-- ë„ë„› í•¨ìˆ˜ -->
	<script th:inline="javascript">
/*<![CDATA[*/
  const maleRatio = /*[[${maleRatio}]]*/ 50;
  const femaleRatio = /*[[${femaleRatio}]]*/ 50;
/*]]>*/
</script>



</body>
<script>
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
	function refreshPage() {
		window.location.reload();
	}
	
    // ì• ë‹ˆë©”ì´ì…˜ ì œëª© ì¶•ì•½
	document.addEventListener("DOMContentLoaded", function () {
    const maxLength = 10;

    document.querySelectorAll(".anime-title").forEach(titleElement => {
        let fullTitle = titleElement.textContent.trim();
        if (fullTitle.length > maxLength) {
            titleElement.setAttribute("data-title", fullTitle);
            titleElement.textContent = fullTitle.substring(0, maxLength) + "...";
        }
    });

    document.querySelectorAll(".anime-card").forEach(card => {
        card.addEventListener("click", function () {
            const animeId = card.getAttribute("data-anime-id");
            const userId = document.getElementById("register_user_id")?.value || "";

            // ê¸°ë³¸ ì •ë³´ ë¡œë”©
            fetch(`/Main/anime/baseInfo?animeId=${animeId}`)
                .then(res => res.json())
                .then(data => {
                    const titleEl = document.getElementById("anime_title");
                    const animeGaroImgEl = document.getElementById("modal_img");

                    if (titleEl) titleEl.innerText = data.title || "ì œëª© ì—†ìŒ";
                    if (animeGaroImgEl) animeGaroImgEl.setAttribute("src", data.thumnailGaroUrl || "IMG/default.png");
                });

            // ìƒì„¸ ì •ë³´ ë¡œë”©
            fetch(`/Main/anime/detailInfo?animeId=${animeId}`)
                .then(res => res.json())
                .then(data => {
                    const startDateEl = document.getElementById("start_date");
                    const totalEpEl = document.getElementById("total_episode");
                    const studioLinkEl = document.getElementById("studio_link");
                    const ratingEl = document.getElementById("age_rating");
                    const descEl = document.getElementById("anime_desc");

                    if (startDateEl) startDateEl.innerText = data.startDate?.substring(0, 10) || "ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    if (totalEpEl) totalEpEl.innerText = data.totalEpisode || "ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    if (studioLinkEl) {
                        studioLinkEl.setAttribute("href", data.studioLink);
                        studioLinkEl.setAttribute("target", "_blank");
                        studioLinkEl.innerText = data.studio || "ì œì‘ì‚¬ ì •ë³´ ì—†ìŒ";
                    }
                    if (ratingEl) ratingEl.innerText = data.ageRating || "ë¯¸ì •";
                    if (descEl) descEl.innerHTML = (data.animeDesc || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.").replace(/\n/g, "<br>");
                });

            // í‰ê°€ ì •ë³´ ë° ìœ ì € ì´ë¯¸ì§€ ë¡œë”©
            fetch("/Schedule/rateInfoJson", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ANIME_ID: animeId })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("grade-number").textContent = data.grade;
                    document.getElementById("grade-mark").textContent = data.gradeMark;
                    updateBarChart(data.scoreList, data.countList);
                    updateDonutChart(data.maleRatio, data.femaleRatio);
                    updateCommentList(data.list);

                    const userProfileImg = data.userProfileImg || '/IMG/kibon_image.jpg'; // ğŸ” ë°±ì—”ë“œì—ì„œ ë³„ë„ë¡œ ë‚´ë ¤ì¤„ ê²ƒ
                    applyUserRatingForm(data.Aldto, animeId, userId, data.userProfileImg);

                    document.getElementById("animeModal").style.display = "block";
                    document.querySelector(".modal_content").scrollTop = 0;
                });
        });
    });
});
  
 	// ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function modal_close() {
        document.getElementById("animeModal").style.display = "none";
        
     // ì¤„ê±°ë¦¬ ë”ë³´ê¸° ì´ˆê¸°í™”
	    const summaryText = document.querySelector('.ani-summary p');
	    const summaryButton = document.getElementById('summaryButton');
	    if (summaryText.classList.contains('expanded')) {
	        summaryText.classList.remove('expanded');
	        summaryButton.textContent = 'ë”ë³´ê¸°';
	    }
    }

    // ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€
    window.onclick = function(event) {
        let modal = document.getElementById("animeModal");
        if (event.target === modal) {  // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ
            modal_close();  // ëª¨ë‹¬ ë‹«ê¸° ì‹¤í–‰
        }
    };
</script>

<script>

function applyUserRatingForm(dto, animeId, userId, profileImgUrl = '/IMG/kibon_image.jpg') {
    // ìˆ˜ì • í¼ê³¼ ë“±ë¡ í¼ì„ ì°¾ê¸°
    const rateFormArea = document.getElementById("rateFormArea");
    const registerFormArea = document.getElementById("registerFormArea");

    // ìˆ˜ì • í¼ì˜ ìš”ì†Œë“¤
    const ratedContent = document.getElementById("rated_content");
    const ratedStarsArea = document.getElementById("rated_stars_area");
    const ratedProfileImg = document.querySelector("#rateFormArea img.profile-img");

    // ë“±ë¡ í¼ì˜ ìš”ì†Œë“¤
    const registerContent = document.getElementById("register_content");
    const registerStarsArea = document.getElementById("register_stars_area");
    const registerProfileImg = document.querySelector("#registerFormArea img.profile-img");

    // í¼ ì´ˆê¸°í™”
    if (rateFormArea && registerFormArea) {
        ratedContent.value = "";
        ratedStarsArea.innerHTML = "";
        registerContent.value = "";
        registerStarsArea.innerHTML = "";
    }

    if (dto) {
        // ìˆ˜ì •í¼ í™œì„±í™”
        rateFormArea.style.display = "block";
        registerFormArea.style.display = "none";

        document.getElementById("rated_user_id").value = dto.USER_ID || userId;
        document.getElementById("rated_anime_id").value = dto.ANIME_ID || animeId;
        document.getElementById("rated_content").value = dto.SCORE_CONTENT || "";

        if (ratedProfileImg) {
            ratedProfileImg.src = dto.USER_PROFILE_IMG || '/IMG/kibon_image.jpg';
        }

        applyStars("rated_stars_area", dto.SCORE_SCORE, "SCORE_SCORE");

    } else {
        // ë“±ë¡í¼ í™œì„±í™”
        rateFormArea.style.display = "none";
        registerFormArea.style.display = "block";

        document.getElementById("register_anime_id").value = animeId;
        document.getElementById("register_user_id").value = userId;
        document.getElementById("register_content").value = "";

        if (registerProfileImg) {
            registerProfileImg.src = profileImgUrl || '/IMG/kibon_image.jpg';
        }

        applyStars("register_stars_area", 3.5, "SCORE_SCORE");
    }
}

function applyStars(containerId, selectedValue, inputName) {
    const area = document.getElementById(containerId);
    area.innerHTML = "";
    const scores = [0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5];
    scores.forEach(score => {
        const id = `${inputName}_${score}`;
        const checked = score === selectedValue ? "checked" : "";
        const type = (score * 10) % 10 === 5 ? "half" : "full";
        area.innerHTML += `
            <label class="rating__label rating__label--${type}" for="${id}">
                <input type="radio" id="${id}" class="rating__input" name="${inputName}" value="${score}" ${checked}/>
                <span class="star-icon"></span>
            </label>`;
    });
}
//í‰ì ê²Œì‹œíŒ ì—…ë°ì´íŠ¸
function updateCommentList(list) {
    const area = document.getElementById("comment-list-area");
    area.innerHTML = "<h1 style='color: white; text-align: center; margin-bottom: 30px;'>ê²Œì‹œíŒ ëª©ë¡</h1>";
    
    list.forEach(dto => {
        const div = document.createElement("div");
        div.className = "comment-card";
        div.innerHTML = `
        	<div class="comment-left">
        	<div id="image-filter">
        	 <img src="${dto.USER_PROFILE_IMG || '/IMG/kibon_image.jpg'}" class="profile-img" />
			</div>
            	<div class="user-id">${dto.USER_NICKNAME}</div>
            <div class="comment-stars">
                ${generateStarsHTML(dto.SCORE_SCORE)}
            </div>
        </div>
        <div class="comment-right">
            <div class="comment-content-box">
                <div class="comment-content">
                    ${dto.SCORE_CONTENT}
                </div>
            </div>
            <div class="comment-meta">
                ${dto.SCORE_REGDATE.substring(0,10) || 'ì‘ì„±ì¼ì ì—†ìŒ'}
            </div>
        </div>
        `;
        area.appendChild(div);
    });
}

function generateStarsHTML(score) {
    const full = Math.floor(score);
    const half = score % 1 >= 0.5 ? 1 : 0;
    let html = "";
    for (let i = 0; i < full; i++) html += `<img src="/IMG/star_full.png" width="20" height="20"/>`;
    if (half) html += `<img src="/IMG/star_half.png" width="20" height="20"/>`;
    return html;
}

function updateDonutChart(maleRatio, femaleRatio) {	
    const canvas = document.getElementById('genderChart');
    if (!canvas) {
        console.warn("genderChart ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const ctx = canvas.getContext('2d');
    const data = [maleRatio, femaleRatio];

    // ì´ë¯¸ í•´ë‹¹ canvasì— ë“±ë¡ëœ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ Chart.js ë‚´ë¶€ ë“±ë¡ë„ ì œê±°
    const existingChart = Chart.getChart(canvas); // Chart.js v3+
    if (existingChart) {
        existingChart.destroy(); // âœ… ì•ˆì „í•˜ê²Œ ì œê±°
    }

    window.genderChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ë‚¨ì„±', 'ì—¬ì„±'],
            datasets: [{
                data: data,
                backgroundColor: ['#36A2EB', '#FF6384']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

</script>
<script>
//ëª¨ë‹¬ ë‚´ë¶€ ì¤„ê±°ë¦¬ í™•ì¥ ë²„íŠ¼
  const summaryText = document.querySelector('.ani-summary p');
  const summaryButton = document.getElementById('summaryButton');

  summaryButton.addEventListener('click', () => {
    summaryText.classList.toggle('expanded');
    if (summaryText.classList.contains('expanded')) {
      summaryButton.textContent = 'ì ‘ê¸°';
    } else {
      summaryButton.textContent = 'ë”ë³´ê¸°';
    }
  });
</script>
<!-- ê¸€ììˆ˜ í™•ì¸ í•¨ìˆ˜ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
	  const maxChars = 100;

	  // register í¼
	  const regTA    = document.getElementById('register_content');
	  const regCount = document.getElementById('register_charCount');
	  // ìˆ˜ì • í¼
	  const ratTA    = document.getElementById('rated_content');
	  const ratCount = document.getElementById('rated_charCount');

	  function attachCounter(textarea, counter) {
	    if (!textarea || !counter) return;
	    // ì´ˆê¸° ì„¸íŒ…
	    counter.textContent = `0/${maxChars}`;
	    textarea.addEventListener('input', () => {
	      // ì´ˆê³¼ ìë™ ì»¤íŠ¸ (maxlength ì¨ë„ í˜¹ì‹œ ëª°ë¼ì„œ)
	      if (textarea.value.length > maxChars) {
	        textarea.value = textarea.value.substring(0, maxChars);
	      }
	      // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
	      counter.textContent = `${textarea.value.length}/${maxChars}`;
	    });
	  }

	  attachCounter(regTA, regCount);
	  attachCounter(ratTA, ratCount);
	});
</script>
<script src="/js/navbar.js"></script>
</html>
